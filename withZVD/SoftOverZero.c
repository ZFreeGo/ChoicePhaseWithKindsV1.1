/***********************************************
*Copyright(c) 2015,FreeGo
*保留所有权利
*文件名称:SoftOverZero.c
*文件标识:
*创建日期： 2015年2月1日
*摘要:
*下午5:29:01:创建本文件
*当前版本:1.0
*作者: FreeGo
*取代版本:
*作者:
*完成时间:
************************************************************/

#include "SoftOverZero.h"
#include "Header.h"
#include "DSP28x_Project.h"
//#include "FIRCoef.h"
/*
#define FIR_ORDER 63
#define SIGNAL_LENGTH (FIR_ORDER + 1) *2*2

//#pragma DATA_SECTION(firFP, "firfilt")
FIR_FP firFP = FIR_FP_DEFAULTS;

//#pragma DATA_SECTION(dbuffer, "firldb")
float dbuffer[FIR_ORDER+1];

//#pragma DATA_SECTION(sigIn, "sigIn");
//#pragma DATA_SECTION(sigOut, "sigOut");
float sigIn[SIGNAL_LENGTH];
float sigOut[SIGNAL_LENGTH];

//#pragma DATA_SECTION(coeff, "coefffilt");
float const coeff[FIR_ORDER+1]= FIR_FP_LPF64;
float RadStep = 0.062831853071f;
float RadStep2 = 2.073451151f;
float Rad = 0.0f;
float Rad2 = 0.0f;
float xn,yn;
int count = 0;
unsigned int k;
*/
/********************************************************************
 * 函数名：FIR_Sample()
 * 参数：
 * 返回值：NULL
 * 功能：
 ********************************************************************/
void FIR_Sample()
{

	//xn=1 * cos(2*PI * 0.0156f * i + PI/2) +
	//0.1 * cos(5*2*PI * 0.0156f * i + PI/3); //Q15


	/* FIR Generic Filter Initialisation */
/*	firFP.order=FIR_ORDER;
	firFP.dbuffer_ptr=dbuffer;
	firFP.coeff_ptr=(float *)coeff;
	firFP.init(&firFP);
	for(k=0; k < 166; k++)//164
	{
		xn=0.5*sin(Rad) + 0.5*sin(Rad2); //Q15
		//xn=1 * cos(2*PI * 0.0156f * i + PI/2) +
		//0.1 * cos(5*2*PI * 0.0156f * i + PI/3); //Q15
		sigIn[k]=xn;
		firFP.input= xn;
		firFP.calc(&firFP);
		yn = firFP.output;
		sigOut[k]=yn;
		Rad = Rad + RadStep;
		Rad2 = Rad2 + RadStep2;
	}*/

}

//采样率6400 每周波128点
const int BPLENGTH = 256;
const float COEEF_BP256[256] = {
  -0.001866335632231,-0.0006514502203817,-0.0007529921941779,-0.000855292481921,
  -0.0009573796988611,-0.001056491026113, -0.00115113166228, -0.00123832249421,
  -0.001316948495107, -0.00138465584207,-0.001440484148492,-0.001481485215859,
  -0.001506377403795,-0.001513871111824,-0.001505588756678,-0.001479682339992,
   -0.00143397881772,-0.001373695393601, -0.00129581839995,-0.001203690346546,
  -0.001099201286691,-0.0009840845587952,-0.0008617726295527,-0.0007347974795195,
  -0.000607651237023,-0.0004834376870865,-0.0003665536919727,-0.0002601365332796,
  -0.0001692450780311,-9.720232664722e-05,-4.791638490224e-05,-2.429313200201e-05,
  -3.068785781906e-05,-6.763136533391e-05,-0.0001391298096382,-0.0002449773635027,
  -0.0003867258251444,-0.0005631851889831,-0.0007739977253789,-0.001016608255214,
  -0.001288868609193,-0.001586338064879,-0.001905320901205, -0.00224011357601,
  -0.002585479725388,-0.002934365118793,-0.003280935497028,-0.003617283045062,
  -0.003936613827459,-0.004231678262759,-0.004495559178729,-0.004721393426376,
  -0.004903442268917,-0.005035846212379,-0.005114709867095,-0.005135917524513,
  -0.005097730326551,-0.004998569352479,-0.004839290685693,-0.004620993065852,
  -0.004347575895396,-0.004023221302481,-0.003654417493651,-0.003248248851225,
  -0.002814169528174, -0.00236132672149,-0.001901517977583,-0.001445688906895,
  -0.001006881996025,-0.0005971594445355,-0.0002298100925289,8.307278442582e-05,
  0.0003288949813737,0.0004969215277098,0.0005764022482636,0.0005588513981706,
  0.0004365830011557,0.0002046940211399,-0.0001407579415644,-0.0006003188344968,
  -0.001173108885725,-0.001855060221298,-0.002640052192015,-0.003518951645203,
  -0.004480586477846,-0.005510802174424,-0.006593873527224,-0.007711205172214,
  -0.008843109623384,-0.009967730849554, -0.01106264567338, -0.01210387887045,
   -0.01306778940797, -0.01393006249274, -0.01466729762766, -0.01525656536264,
   -0.01567676364826, -0.01590788154611, -0.01593286866037, -0.01573640392374,
   -0.01530691881698, -0.01463536780107,  -0.0137167720787, -0.01254939023173,
   -0.01113582850918,-0.009482089280613,-0.007598659683208,-0.005499519298458,
  -0.003202768423816,-0.0007296969364454,  0.00189455381678, 0.004642387073714,
   0.007483112111052,  0.01038416331111,  0.01331109590126,   0.0162283265164,
    0.01909959873423,  0.02188863682949,  0.02455947089136,   0.0270774113143,
    0.02940921075565,  0.03152383982674,  0.03339286687957,   0.0349911013224,
    0.03629674573534,  0.03729195823139,  0.03796317436107,  0.03830108135769,
    0.03830108135769,  0.03796317436107,  0.03729195823139,  0.03629674573534,
     0.0349911013224,  0.03339286687957,  0.03152383982674,  0.02940921075565,
     0.0270774113143,  0.02455947089136,  0.02188863682949,  0.01909959873423,
     0.0162283265164,  0.01331109590126,  0.01038416331111, 0.007483112111052,
   0.004642387073714,  0.00189455381678,-0.0007296969364454,-0.003202768423816,
  -0.005499519298458,-0.007598659683208,-0.009482089280613, -0.01113582850918,
   -0.01254939023173,  -0.0137167720787, -0.01463536780107, -0.01530691881698,
   -0.01573640392374, -0.01593286866037, -0.01590788154611, -0.01567676364826,
   -0.01525656536264, -0.01466729762766, -0.01393006249274, -0.01306778940797,
   -0.01210387887045, -0.01106264567338,-0.009967730849554,-0.008843109623384,
  -0.007711205172214,-0.006593873527224,-0.005510802174424,-0.004480586477846,
  -0.003518951645203,-0.002640052192015,-0.001855060221298,-0.001173108885725,
  -0.0006003188344968,-0.0001407579415644,0.0002046940211399,0.0004365830011557,
  0.0005588513981706,0.0005764022482636,0.0004969215277098,0.0003288949813737,
  8.307278442582e-05,-0.0002298100925289,-0.0005971594445355,-0.001006881996025,
  -0.001445688906895,-0.001901517977583, -0.00236132672149,-0.002814169528174,
  -0.003248248851225,-0.003654417493651,-0.004023221302481,-0.004347575895396,
  -0.004620993065852,-0.004839290685693,-0.004998569352479,-0.005097730326551,
  -0.005135917524513,-0.005114709867095,-0.005035846212379,-0.004903442268917,
  -0.004721393426376,-0.004495559178729,-0.004231678262759,-0.003936613827459,
  -0.003617283045062,-0.003280935497028,-0.002934365118793,-0.002585479725388,
   -0.00224011357601,-0.001905320901205,-0.001586338064879,-0.001288868609193,
  -0.001016608255214,-0.0007739977253789,-0.0005631851889831,-0.0003867258251444,
  -0.0002449773635027,-0.0001391298096382,-6.763136533391e-05,-3.068785781906e-05,
  -2.429313200201e-05,-4.791638490224e-05,-9.720232664722e-05,-0.0001692450780311,
  -0.0002601365332796,-0.0003665536919727,-0.0004834376870865,-0.000607651237023,
  -0.0007347974795195,-0.0008617726295527,-0.0009840845587952,-0.001099201286691,
  -0.001203690346546, -0.00129581839995,-0.001373695393601, -0.00143397881772,
  -0.001479682339992,-0.001505588756678,-0.001513871111824,-0.001506377403795,
  -0.001481485215859,-0.001440484148492, -0.00138465584207,-0.001316948495107,
   -0.00123832249421, -0.00115113166228,-0.001056491026113,-0.0009573796988611,
  -0.000855292481921,-0.0007529921941779,-0.0006514502203817,-0.001866335632231
};

/********************************************************************
 * 函数名：FirInit()
 * 参数：void
 * 返回值：void
 * 功能： Fir滤波的初始化，诸如变量等等
 ********************************************************************/
void FirInit(void)
{

}


/********************************************************************
 * 函数名：FIR_Self()
 * 参数：
 * float* b 滤波系数数组
 * Uint16 blen 滤波系数长度
 * float *x  输入数组
 * Uint16 len 输入数组长度
 * float* out 输出
 * 返回值：NULL
 * 功能： FIR C实现，暂不考虑实时性,约定为对称结构  len需要大于blen len-blen即为out的长度
 ********************************************************************/
void FIR_Self(float* b, Uint16 blen, float *x,  Uint16 len, float* out)
{
	   Uint16 half = 0; //折半数据
	   Uint16 gi = 0; //奇偶判断
	   Uint16 k = 0, j = 0, i = 0;
	   float sum = 0;
	   //奇偶判断
	   if (! (blen % 2))
	   {
	       //blen为偶数
	       half = blen / 2;
	       gi = 0;
	   }
	   else
	   {
	       //blen为奇数
	       half = (blen-1) / 2;
	       gi = 1;
	   }

	   for( j = blen - 1;  j < len ; j++)
	   {
	       sum = 0;
	       for( i = 0; i < half; i++)
	       {
	    	   sum += b[i]*(x[j-i]  + x[j+1- (blen-i)]);
	       }

	       if (gi)
	       {
	    	   sum +=  b[half] * x[j - half-1];
	       }
	       out[k++] = sum;
	   }

}




//%计算零点 array--数据 start--开始范围 end--结束范围 N--基波点数
/********************************************************************
 * 函数名：SearchZero()
 * 参数：
 * float* array ―― 数组
 * Uint16 start ―― 开始索引
 * Uint16 endIndex ――结束索引
 * float offset ―― 偏置
 * float* index ―― 搜索到的过零索引
 * 返回值：NULL
 * 功能：计算频率模块，根据数据计算频率
 ********************************************************************/
Uint16 SearchZero(float* array,Uint16 start,Uint16 endIndex,
				float offset, float* index)
{
	Uint16 k = 0, i = 0;
    float a = 0, b =0;
    for( i = start; i < endIndex ; i++)
	{
        a = array[i]- offset;
        b = array[i + 1]- offset;
        if (a * b < 0) //%具体实现可考虑别的方法
        {
            a = i + (0-a)/(b - a);
            index[k++] = a;
        }
	}
    return k;

}

